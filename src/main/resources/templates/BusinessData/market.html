<!DOCTYPE html>
<html>
<head>
    <title>行情数据</title>
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width,user-scalable=yes, minimum-scale=0.4, initial-scale=0.8,target-densitydpi=low-dpi">
    <meta http-equiv="Cache-Control" content="no-siteapp"/>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <link rel="stylesheet" href="../css/font.css">
    <link rel="stylesheet" href="../css/xadmin.css">
    <link rel="stylesheet" href="../css/theme9.css">
    <script src="../lib/layui/layui.js" charset="UTF-8"></script>
    <script type="text/javascript" src="../js/xadmin.js"></script>
    <!-- 让IE8/9支持媒体查询，从而兼容栅格 -->
    <!--[if lt IE 9]-->
    <script src="https://cdn.staticfile.org/html5shiv/r29/html5.min.js"></script>
    <script src="https://cdn.staticfile.org/respond.js/1.4.2/respond.min.js"></script>

    <link rel="stylesheet" href="../lib/layui/css/layui.css" type="text/css">
    
    <script src="../lib/layui/layui.js"></script>

    <script type="text/html" id="toolbarDemo">
    <div style="float: right">
        <button class="layui-btn layui-btn-sm" lay-event="shangHai">导入上海行情</button>
        <button class="layui-btn layui-btn-sm" lay-event="shenZhen">导入深圳行情</button>
        <button class="layui-btn layui-btn-sm layui-btn-normal" lay-event="add">
            <i class="layui-icon">&#xe654;</i>添加行情
        </button>
        <button class="layui-btn layui-btn-sm layui-btn-danger" lay-event="deleteAll">
            <i class="layui-icon">&#xe640;</i>批量删除
        </button>
    </div>
    <br/>
    <form class="layui-form layui-col-space5">
        <div class="layui-inline layui-show-xs-block">
            <label class="layui-form-label layui-bg-green"
                   style="width: 100px;text-align: center;float: left">证券编号</label>
            <div class="layui-inline layui-show-xs-block" style="float: left">
                <input type="text" class="layui-input" autocomplete="off" placeholder="请输入证券编号">
            </div>
        </div>
        <div class="layui-inline layui-show-xs-block">
            <label class="layui-form-label layui-bg-green"
                   style="width: 110px;text-align: center">日期</label>
            <div class="layui-inline layui-show-xs-block">
                <input class="layui-input" autocomplete="off" placeholder="请输入库存日期" id="storageDate">
            </div>
        </div>
        <div class="layui-inline layui-show-xs-block">
            <button class="layui-btn" lay-submit="" lay-filter="sreach"><i class="layui-icon">&#xe615;</i>搜索
            </button>
        </div>
    </form>
    </script>
    <script type="text/javascript">
        layui.use(['element', 'form', 'table', 'layer', 'laydate', 'laypage','upload'], function () {
            var layer = layui.layer;
            var $ = layui.$;
            var table = layui.table;
            var form = layui.form;
            var upload = layui.upload;
            var laydate = layui.laydate;
            var laypage = layui.laypage;

            //执行一个laydate实例
            laydate.render({
                elem: '#storageDate'
            });

            laydate.render({
                elem: '#endTime1'
            });

            laydate.render({
                elem: '#endTime2'
            });
            //向世界问个好
            layer.msg('欢迎进入基金估值核算系统');

            //新增提交
            form.on('submit(addsubmit)', function (data) {
                var formData = $('#addform').serialize();
                $.post("market/insertMarket", formData, function (msg) {
                    if (msg > 0) {
                        table.reload('userTable');
                        layer.closeAll();
                        layer.msg('添加成功', {
                            title: '提示',
                            area: ['200px',
                                '140px'],
                            time: 0,
                            btn: ['知道了']
                        });
                    } else {
                        layer.closeAll();
                        layer.msg('添加失败', {
                            title: '提示',
                            area: ['200px',
                                '140px'],
                            time: 0,
                            btn: ['知道了']
                        });
                    }
                });
                return false;
            });
            //修改提交
            form.on('submit(editsubmit)', function (data) {
                var formData = $('#editform').serialize();
                $.post("market/updateMarket", formData, function (msg) {
                    if (msg > 0) {
                        table.reload('userTable');
                        layer.closeAll();
                        layer.msg('修改成功', {
                            title: '提示',
                            area: ['200px',
                                '140px'],
                            time: 0,
                            btn: ['知道了']
                        });
                    } else {
                        layer.closeAll();
                        layer.msg('修改失败', {
                            title: '提示',
                            area: ['200px',
                                '140px'],
                            time: 0,
                            btn: ['知道了']
                        });
                    }
                });
                return false;
            });
            //执行一个 table 实例
            table.render({
                elem: '#userTable'
                , url: 'market/selectMarket' //数据接口
                , title: '行情数据表'
                , page: true //开启分页
                , toolbar: '#toolbarDemo' //开启工具栏，此处显示默认图标，可以自定义模板，详见文档
                , totalRow: true //开启合计行
                , height: 'full-50'
                , cellMinWidth: 60
                , cols: [
                    [ //表头
                        {type: 'checkbox', fixed: 'left'}
                        , {field: 'marketId', title: '行情ID', sort: true, fixed: 'left', totalRowText: '合计：'}
                        , {field: 'securitiesId', title: '证券编号'}
                        , {field: 'securitiesName', title: '证券名称', sort: true, totalRow: true}
                        , {field: 'dateTime', title: '日期', sort: true}
                        , {field: 'openPrice', title: '开盘价格', sort: true, totalRow: true}
                        , {field: 'closingPrice', title: '闭市价格'}
                        , {field: 'desc', title: '备注'}
                        , {fixed: '操作', minWidth: 165, align: 'center', toolbar: '#barDemo'}
                    ]
                ]
            });

            //上传
            upload.render({
                elem: '#uploadDeepMarket'
                , url: 'https://httpbin.org/post' //改成您自己的上传接口
                , done: function (res) {
                    layer.msg('上传成功');
                    layui.$('#test9').removeClass('layui-hide').find('img').attr('src', res.files.file);
                    console.log(res)
                }
            });
            //给工具条的按钮添加事件
            table.on('toolbar(userTable)', function (obj) {
                //获取选中复选框的对象，
                var checkStatus = table.checkStatus(obj.config.id);//得到表格选中行的ID
                switch (obj.event) {
                    case 'add':
                        var index = layer.open({
                            type: 1,
                            title: '添加行情数据',
                            closeBtn: 1,
                            move: false,
                            content: $("#addContent"),
                            btn: []
                        });
                        $.ajax({
                            url: 'market/selectMarket',
                            dataType: 'json',
                            type: 'post',
                            success: function (obj) {
                                $.each(obj, function (index, item) {
                                    $('#roleId').append(new Option(item.roleName, item.roleId));//往下拉菜单里添加元素
                                })
                                form.render();//菜单渲染 把内容加载进去
                            }
                        })
                        form.render();
                        //全屏
                        layer.full(index);
                        break;
                    case 'search':
                        alert("搜索");
                        var userName = $("#userName").val();
                        //表格的重新加载事件
                        table.reload('userTable', {
                            method: 'post'
                            , where: {
                                'userName': userName
                            }
                            , page: {
                                curr: 1
                            }
                        });

                        break;
                    case 'deleteAll':
                        var data = checkStatus.data;
                        //    layer.alert(JSON.stringify(data));
                        if (data.length == 0) {
                           /* layer.msg("请至少选择一条数据",)*/
                        } else {
                            var ids = [];
                            for (var i = 0; i < data.length; i++) {
                                ids.push(data[i].userId);
                            }
                            layer.confirm('真的删除行么', {icon: 2}, function (index) {
                                layer.close(index);
                                $.post("market/deleteMarket", {userId: ids.join(',')}, function (msg) {
                                    table.reload('userTable');
                                    layer.msg('删除' + checkStatus.data.length + '条记录', {
                                        title: '提示',
                                        area: ['200px', '140px'],
                                        time: 0,
                                        btn: ['知道了']
                                    });
                                });
                            });
                        }
                        break;
                    case 'shangHai':
                        var index = layer.open({
                            type: 1,
                            title: '导入上海行情',
                            closeBtn: 1,
                            move:false,
                            content:$('#uploadOnSeaMarket'),
                            btn:[]
                        });
                        layer.full(index);
                        break;
                    case 'shenZhen':
                        var index = layer.open({
                            type: 1,
                            title: '导入深圳行情',
                            closeBtn: 1,
                            move:false,
                            content:$('#uploadOnSeaMarket'),
                            btn:[]
                        });
                        layer.full(index);
                        break;
            }
            });
            //给表格编辑，删除按钮添加点击事件
            table.on('tool(userTable)', function (obj) {
                var data = obj.data;//得到删除行整行的数据
                alert(data.userId);
                if (obj.event === 'del') {
                    layer.confirm('真的删除行么', {icon: 2}, function (index) {
                        layer.close(index);
                        $.post("market/deleteMarket", {userId: data.userId + ""}, function (msg) {
                            table.reload('userTable');
                        });

                    });
                } else if (obj.event === 'edit') {
                    alert(JSON.stringify(data));

                    form.val('editform', $.parseJSON(JSON.stringify(data)));
                    var index = layer.open({
                        type: 1,
                        title: '修改行情数据',
                        closeBtn: 1,
                        move: false,
                        area: ['500px', '400px'],
                        content: $('#editContent')
                    });
                    $.ajax({
                        url: 'market/selectMarket',
                        dataType: 'json',
                        type: 'post',
                        success: function (obj) {

                            $.each(obj, function (index, item) {
                                $('#roleId_2').append(new Option(item.roleName, item.roleId));//往下拉菜单里添加元素
                            })
                            $("#roleId_2 option[value='" + data.roleId + "']").attr("selected", "selected");
                            form.render();//菜单渲染 把内容加载进去
                        }
                    })
                    form.render();
                    layer.full(index);
                }
            });
        });
        function myclose() {
            parent.layer.closeAll();
        }
    </script>
</head>

<body style="overflow: auto; background-color: white;"
      class="layui-view-body layui-content">


<div>

    <!--表格-->
    <table id="userTable" lay-filter="userTable"></table>

    <!--工具条-->
    <div style="display: none;" id="barDemo">
        <a class="layui-btn layui-btn-xs" lay-event="edit"><i
                class="layui-icon">&#xe642;</i>编辑</a>
        <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del"><i
                class="layui-icon">&#xe640;</i>删除</a>
    </div>
</div>
<!--增加的div内容-->
<div id="addContent"
     style="display: none; height: 100%; height: 100%; text-align: center;">
    <form id="addform" lay-filter="addform"
          class="layui-form layui-form-pane"
          style="margin: 30px auto; display: inline-block;">
        <div class="layui-inline layui-show-xs-block">
            <label class="layui-form-label layui-bg-green">证券编号</label>
            <div class="layui-inline layui-show-xs-block" style="float: left">
                <input type="text" class="layui-input" autocomplete="off" placeholder="请输入证券编号">
            </div>
        </div>
        <br/><br/>
        <div class="layui-inline layui-show-xs-block">
            <label class="layui-form-label layui-bg-green">录入日期</label>
            <div class="layui-inline layui-show-xs-block">
                <input class="layui-input" autocomplete="off" placeholder="请输入日期" name="endTime" id="endTime1">
            </div>
        </div>
        <br/><br/>
        <div class="layui-inline layui-show-xs-block">
            <label class="layui-form-label layui-bg-green">开盘价格</label>
            <div class="layui-inline layui-show-xs-block" style="float: left">
                <input type="number" class="layui-input" oninput="javascript:this.value=this.value.replace(/[^\d]/g,'')"
                       autocomplete="off" placeholder="请输入开盘价格">
            </div>
        </div>
        <br/><br/>
        <div class="layui-inline layui-show-xs-block">
            <label class="layui-form-label layui-bg-green">收盘价格</label>
            <div class="layui-inline layui-show-xs-block" style="float: left">
                <input type="number" step="1" min="0"  
                       oninput="javascript:this.value=this.value.replace(/[^\d]/g,'')"
                       class="layui-input" autocomplete="off" placeholder="请输入收盘价格">
            </div>
        </div>
        <br/><br/>
        <div class="layui-inline layui-show-xs-block">
            <label class="layui-form-label layui-bg-green" style="height: 100px;line-height: 100px">描述</label>
            <div class="layui-inline layui-show-xs-block" style="float: left">
                <textarea rows="" class="layui-textarea" cols="" autocomplete="off"></textarea>
            </div>
        </div>

        <div style="position: absolute; bottom: 0px; left: 45%;">
            <button class="layui-btn" lay-submit="" lay-filter="addsubmit">
                <i class="layui-icon">&#x1005;</i>添加
            </button>
            <button class="layui-btn layui-bg-red cancel" type="button" onclick="myclose()">
                <i class="layui-icon">&#x1006;</i>取消
            </button>
        </div>
    </form>
</div>

<!--修改的div内容-->
<div id="editContent"
     style="display: none; height: 100%; height: 100%; text-align: center;">
    <form id="editform" lay-filter="editform"
          class="layui-form layui-form-pane"
          style="margin: 30px auto; display: inline-block;">
        <div class="layui-form-item" style="text-align: center;">
            <label class="layui-form-label">用户ID</label>
            <div class="layui-input-inline">
                <input type="text" name="userId" lay-verify="required"
                       autocomplete="off" placeholder="请输入用户ID" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item" style="text-align: center;">
            <label class="layui-form-label">用户名</label>
            <div class="layui-input-inline">
                <input type="text" name="userName" lay-verify="required"
                       autocomplete="off" placeholder="请输入用户名" class="layui-input">
            </div>
        </div>

        <div class="layui-form-item" style="text-align: center;">
            <label class="layui-form-label">密码：</label>
            <div class="layui-input-inline">
                <input type="password" name="userPwd" lay-verify="required"
                       autocomplete="off" placeholder="请输入密码" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item" style="text-align: center;">
            <label class="layui-form-label">请选择角色</label>
            <div class="layui-input-inline">
                <select id="roleId_2" name="roleId" xm-select="add" xm-select-radio=""
                        xm-select-search="" lay-verify="required"
                        xm-select-direction="down" xm-select-search-type="dl">
                </select>
            </div>
        </div>
        <div style="position: absolute; bottom: 0px; left: 45%;">
            <button class="layui-btn" lay-submit="" lay-filter="editsubmit">
                <i class="layui-icon">&#x1005;</i>添加
            </button>
            <button class="layui-btn layui-bg-red cancel" type="button">
                <i class="layui-icon">&#x1006;</i>取消
            </button>
        </div>
    </form>
</div>
<div class="layui-tab-item" id="uploadOnSeaMarket"
     style="display: none; height: 100%; height: 100%; text-align: center;">
    <fieldset class="layui-elem-field layui-field-title"
              style="margin-top: 30px;">
        <div class="layui-input-inline">
            <input type="text" style="height: 32px;" id="endTime2"
                   name="dateTime" readonly="readonly" autocomplete="off"  lay-verify="required"
                   placeholder="请输入时间" class="layui-input"> <span id="aftd"></span>
        </div>
        <legend style="font-size:25px">拖拽上传</legend>
    </fieldset>
    <div class="layui-upload-drag" id="uploadDemo">
        <i class="layui-icon"></i>
        <p>点击上传，或将文件拖拽到此处</p>
        <div class="layui-hide" id="uploadDemoView">
            <hr>
            <img src="" alt="上传成功后渲染" style="max-width: 100%">
        </div>
    </div>
    <div>
        <button type="button" class="layui-btn" id="test2">开始上传</button>
        <span id="zx2"></span>
    </div>
</div>

</body>
</html>
